<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="The home of Agent Integrations developer documentation" name="description"/><link href="https://datadoghq.dev/integrations-core/base/databases/" rel="canonical"/><meta content="Datadog" name="author"/><link href="../../assets/images/favicon.ico" rel="shortcut icon"/><meta content="mkdocs-1.1.2, mkdocs-material-5.5.7" name="generator"/><title>Databases - Agent Integrations</title><link href="../../assets/stylesheets/main.b8ac9624.min.css" rel="stylesheet"/><link href="../../assets/stylesheets/palette.28f3ef9a.min.css" rel="stylesheet"/><meta content="#7e57c2" name="theme-color"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link href="../../assets/css/custom.css" rel="stylesheet"/><link href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@4/distr/fira_code.css" rel="stylesheet"/></head> <body data-md-color-accent="deep-purple" data-md-color-primary="deep-purple" data-md-color-scheme="slate" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#interface"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav aria-label="Header" class="md-header-nav md-grid"> <a aria-label="Agent Integrations" class="md-header-nav__button md-logo" href="https://datadoghq.dev/integrations-core/" title="Agent Integrations"> <img alt="logo" src="../../assets/images/logo.svg"/> </a> <label class="md-header-nav__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg> </label> <div class="md-header-nav__title" data-md-component="header-title"> <div class="md-header-nav__ellipsis"> <span class="md-header-nav__topic md-ellipsis"> Agent Integrations </span> <span class="md-header-nav__topic md-ellipsis"> Databases </span> </div> </div> <label class="md-header-nav__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </label> <button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg> </button> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix=""> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> <div class="md-header-nav__source"> <a class="md-source" href="https://github.com/DataDog/integrations-core/" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg> </div> <div class="md-source__repository"> datadog/integrations-core </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <nav aria-label="Tabs" class="md-tabs md-tabs--active" data-md-component="tabs"> <div class="md-tabs__inner md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link md-tabs__link--active" href="../about/"> Base Package </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../ddev/about/"> Dev Package </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../guidelines/pr/"> Guidelines </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../meta/ci/"> Meta </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../tutorials/jmx/tools/"> Tutorials </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../architecture/snmp/"> Architecture </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../process/integration-release/"> Process </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../faq/faq/"> FAQ </a> </li> </ul> </div> </nav> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="Agent Integrations" class="md-nav__button md-logo" href="https://datadoghq.dev/integrations-core/" title="Agent Integrations"> <img alt="logo" src="../../assets/images/logo.svg"/> </a> Agent Integrations </label> <div class="md-nav__source"> <a class="md-source" href="https://github.com/DataDog/integrations-core/" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg> </div> <div class="md-source__repository"> datadog/integrations-core </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../.." title="Home"> Home </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../setup/" title="Setup"> Setup </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../testing/" title="Testing"> Testing </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../e2e/" title="E2E"> E2E </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-5" id="nav-5" type="checkbox"/> <label class="md-nav__link" for="nav-5"> Base Package <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Base Package" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-5"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Base Package </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../about/" title="About"> About </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../basics/" title="Basics"> Basics </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../http/" title="HTTP"> HTTP </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/> <label class="md-nav__link md-nav__link--active" for="__toc"> Databases <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"></path></svg> </span> </label> <a class="md-nav__link md-nav__link--active" href="./" title="Databases"> Databases </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Table of contents </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#interface"> Interface </a> <nav aria-label="Interface" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query"> Query </a> <nav aria-label="Query" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query.__init__"> __init__() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query.compile"> compile() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager"> QueryManager </a> <nav aria-label="QueryManager" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.__init__"> __init__() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.compile_queries"> compile_queries() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.execute"> execute() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.execute_query"> execute_query() </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#transformers"> Transformers </a> <nav aria-label="Transformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers"> ColumnTransformers </a> <nav aria-label="ColumnTransformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.match"> match() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.monotonic_gauge"> monotonic_gauge() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.service_check"> service_check() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.tag"> tag() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.temporal_percent"> temporal_percent() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.time_elapsed"> time_elapsed() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers"> ExtraTransformers </a> <nav aria-label="ExtraTransformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.expression"> expression() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.percent"> percent() </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../prometheus/" title="Prometheus"> Prometheus </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../metadata/" title="Metadata"> Metadata </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../api/" title="API"> API </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" id="nav-6" type="checkbox"/> <label class="md-nav__link" for="nav-6"> Dev Package <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Dev Package" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-6"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Dev Package </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../ddev/about/" title="What's in the box?"> What's in the box? </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../ddev/test/" title="Test framework"> Test framework </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../ddev/plugins/" title="Plugins"> Plugins </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../ddev/configuration/" title="Configuration"> Configuration </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../ddev/cli/" title="CLI"> CLI </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" id="nav-7" type="checkbox"/> <label class="md-nav__link" for="nav-7"> Guidelines <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Guidelines" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-7"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Guidelines </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../guidelines/pr/" title="Pull requests"> Pull requests </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../guidelines/style/" title="Style"> Style </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../guidelines/dashboards/" title="Dashboards"> Dashboards </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../guidelines/conventions/" title="Conventions"> Conventions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" id="nav-8" type="checkbox"/> <label class="md-nav__link" for="nav-8"> Meta <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Meta" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-8"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Meta </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../meta/ci/" title="CI"> CI </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../meta/cd/" title="CD"> CD </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../meta/docs/" title="Docs"> Docs </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../meta/config-specs/" title="Config specs"> Config specs </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../meta/status/" title="Status"> Status </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" id="nav-9" type="checkbox"/> <label class="md-nav__link" for="nav-9"> Tutorials <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Tutorials" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-9"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Tutorials </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-1" id="nav-9-1" type="checkbox"/> <label class="md-nav__link" for="nav-9-1"> JMX <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="JMX" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-9-1"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> JMX </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/jmx/tools/" title="JMX Tools"> JMX Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2" id="nav-9-2" type="checkbox"/> <label class="md-nav__link" for="nav-9-2"> SNMP <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="SNMP" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-9-2"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> SNMP </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/snmp/introduction/" title="Introduction to SNMP"> Introduction to SNMP </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/snmp/profiles/" title="Build an SNMP Profile"> Build an SNMP Profile </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/snmp/how-to/" title="SNMP How-To"> SNMP How-To </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/snmp/profile-format/" title="Profile Format Reference"> Profile Format Reference </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/snmp/sim-format/" title="Simulation Data Format Reference"> Simulation Data Format Reference </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tutorials/memory-profiling/" title="Memory profiling"> Memory profiling </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" id="nav-10" type="checkbox"/> <label class="md-nav__link" for="nav-10"> Architecture <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Architecture" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-10"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Architecture </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../architecture/snmp/" title="SNMP"> SNMP </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../architecture/vsphere/" title="vSphere"> vSphere </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11" id="nav-11" type="checkbox"/> <label class="md-nav__link" for="nav-11"> Process <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Process" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-11"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Process </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../process/integration-release/" title="Integration release"> Integration release </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11-2" id="nav-11-2" type="checkbox"/> <label class="md-nav__link" for="nav-11-2"> Agent release <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Agent release" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-11-2"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Agent release </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../process/agent-release/pre-release/" title="Pre release"> Pre release </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../process/agent-release/post-release/" title="Post release"> Post release </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12" id="nav-12" type="checkbox"/> <label class="md-nav__link" for="nav-12"> FAQ <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="FAQ" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-12"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> FAQ </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../faq/faq/" title="FAQ"> FAQ </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../faq/acknowledgements/" title="Acknowledgements"> Acknowledgements </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Table of contents </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#interface"> Interface </a> <nav aria-label="Interface" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query"> Query </a> <nav aria-label="Query" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query.__init__"> __init__() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.query.Query.compile"> compile() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager"> QueryManager </a> <nav aria-label="QueryManager" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.__init__"> __init__() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.compile_queries"> compile_queries() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.execute"> execute() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.core.QueryManager.execute_query"> execute_query() </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#transformers"> Transformers </a> <nav aria-label="Transformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers"> ColumnTransformers </a> <nav aria-label="ColumnTransformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.match"> match() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.monotonic_gauge"> monotonic_gauge() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.service_check"> service_check() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.tag"> tag() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.temporal_percent"> temporal_percent() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.time_elapsed"> time_elapsed() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers"> ExtraTransformers </a> <nav aria-label="ExtraTransformers" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.expression"> expression() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.percent"> percent() </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content"> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href="https://github.com/DataDog/integrations-core/blob/master/docs/developer/base/databases.md" title="Edit this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg> </a> <h1>Databases</h1> <hr/> <div align="center"> <video autoplay="" loop="" muted="" preload="auto"> <source src="https://media.giphy.com/media/dIBLtolI6axTGIGopo/giphy.mp4" type="video/mp4"/> </video> </div> <p>No matter the database you wish to monitor, the base package provides a standard way to define and collect data from arbitrary queries.</p> <p>The core premise is that you define a function that accepts a query (usually a <code>str</code>) and it returns a sequence of equal length results.</p> <h2 id="interface">Interface<a class="headerlink" href="#interface" title="Permanent link">¶</a></h2> <p>All the functionality is exposed by the <code>Query</code> and <code>QueryManager</code> classes.</p> <div class="doc doc-object doc-class"> <h3 class="doc doc-heading" id="datadog_checks.base.utils.db.query.Query"> <code>datadog_checks.base.utils.db.query.Query</code> <a class="headerlink" href="#datadog_checks.base.utils.db.query.Query" title="Permanent link">¶</a></h3> <div class="doc doc-contents first"> <p>This class accepts a single <code>dict</code> argument which is necessary to run the query. The representation is based on our <code>custom_queries</code> format originally designed and implemented in <a class="magiclink magiclink-github magiclink-pull" href="https://github.com/DataDog/integrations-core/pull/1528" title="GitHub Pull Request: DataDog/integrations-core!1528">!1528</a>.</p> <p>It is now part of all our database integrations and <a href="https://cloud.google.com/solutions/sap/docs/sap-hana-monitoring-agent-user-guide#defining_custom_queries">other</a> products have since adopted this format.</p> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.query.Query.__init__"> <code class="highlight language-python"> __init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_data</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-special"><code>special</code></small> </span> <a class="headerlink" href="#datadog_checks.base.utils.db.query.Query.__init__" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>21
22
23
24
25
26
27</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_data</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">query_data</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.query.Query.compile"> <code class="highlight language-python"> compile<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_transformers</span><span class="p">,</span> <span class="n">extra_transformers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.query.Query.compile" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>This idempotent method will be called by <code>QueryManager.compile_queries</code> so you should never need to call it directly.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span> 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_transformers</span><span class="p">,</span> <span class="n">extra_transformers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    This idempotent method will be called by `QueryManager.compile_queries` so you</span>
<span class="sd">    should never need to call it directly.</span>
<span class="sd">    """</span>
    <span class="c1"># Check for previous compilation</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">query_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'query field `name` is required'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'query field `name` must be a string'</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'query'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `query` for </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `query` for </span><span class="si">{}</span><span class="s1"> must be a string'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'columns'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `columns` for </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `columns` for </span><span class="si">{}</span><span class="s1"> must be a list'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'tags'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `tags` for </span><span class="si">{}</span><span class="s1"> must be a list'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>

    <span class="c1"># Keep track of all defined names</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">column_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Columns can be ignored via configuration.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="p">:</span>
            <span class="n">column_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'column #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is not a mapping'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>

        <span class="n">column_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `name` for column #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `name` for column #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> must be a string'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">'the name </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> was already defined in </span><span class="si">{}</span><span class="s1"> #</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">column_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">sources</span><span class="p">[</span><span class="n">column_name</span><span class="p">][</span><span class="s1">'type'</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="n">column_name</span><span class="p">][</span><span class="s1">'index'</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">sources</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'column'</span><span class="p">,</span> <span class="s1">'index'</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>

        <span class="n">column_type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'type'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `type` for column </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `type` for column </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> must be a string'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">column_type</span> <span class="o">==</span> <span class="s1">'source'</span><span class="p">:</span>
            <span class="n">column_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column_name</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">column_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_transformers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown type `</span><span class="si">{}</span><span class="s1">` for column </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>

        <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">)}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">column_transformers</span><span class="p">[</span><span class="n">column_type</span><span class="p">](</span><span class="n">column_transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">'error compiling type `</span><span class="si">{}</span><span class="s1">` for column </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">column_type</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">)</span>

            <span class="c1"># Prepend helpful error text.</span>
            <span class="c1">#</span>
            <span class="c1"># When an exception is raised in the context of another one, both will be printed. To avoid</span>
            <span class="c1"># this we set the context to None. https://www.python.org/dev/peps/pep-0409/</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="n">error</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column_type</span> <span class="o">==</span> <span class="s1">'tag'</span><span class="p">:</span>
                <span class="n">column_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column_name</span><span class="p">,</span> <span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="n">transformer</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># All these would actually submit data. As that is the default case, we represent it as</span>
                <span class="c1"># a reference to None since if we use e.g. `value` it would never be checked anyway.</span>
                <span class="n">column_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column_name</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">transformer</span><span class="p">)))</span>

    <span class="n">submission_transformers</span> <span class="o">=</span> <span class="n">column_transformers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">submission_transformers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'tag'</span><span class="p">)</span>

    <span class="n">extras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'extras'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `extras` for </span><span class="si">{}</span><span class="s1"> must be a list'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_name</span><span class="p">))</span>

    <span class="n">extra_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'extra #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is not a mapping'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>

        <span class="n">extra_name</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extra_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `name` for extra #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `name` for extra #</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> must be a string'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">extra_name</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">'the name </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> was already defined in </span><span class="si">{}</span><span class="s1"> #</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">sources</span><span class="p">[</span><span class="n">extra_name</span><span class="p">][</span><span class="s1">'type'</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="n">extra_name</span><span class="p">][</span><span class="s1">'index'</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">sources</span><span class="p">[</span><span class="n">extra_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'extra'</span><span class="p">,</span> <span class="s1">'index'</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>

        <span class="n">extra_type</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'type'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extra_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'expression'</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">extra_type</span> <span class="o">=</span> <span class="s1">'expression'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `type` for extra </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `type` for extra </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> must be a string'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">extra_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_transformers</span> <span class="ow">and</span> <span class="n">extra_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">submission_transformers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown type `</span><span class="si">{}</span><span class="s1">` for extra </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_type</span><span class="p">,</span> <span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>

        <span class="n">transformer_factory</span> <span class="o">=</span> <span class="n">extra_transformers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extra_type</span><span class="p">,</span> <span class="n">submission_transformers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extra_type</span><span class="p">))</span>

        <span class="n">extra_source</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'source'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_type</span> <span class="ow">in</span> <span class="n">submission_transformers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">extra_source</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'field `source` for extra </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> is required'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">))</span>

            <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">,</span> <span class="s1">'source'</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">)}</span>
            <span class="n">modifiers</span><span class="p">[</span><span class="s1">'sources'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer_factory</span><span class="p">(</span><span class="n">submission_transformers</span><span class="p">,</span> <span class="n">extra_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">'error compiling type `</span><span class="si">{}</span><span class="s1">` for extra </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_type</span><span class="p">,</span> <span class="n">extra_name</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="n">raise_from</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="n">error</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extra_type</span> <span class="ow">in</span> <span class="n">submission_transformers</span><span class="p">:</span>
                <span class="n">transformer</span> <span class="o">=</span> <span class="n">create_extra_transformer</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">extra_source</span><span class="p">)</span>

            <span class="n">extra_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">extra_name</span><span class="p">,</span> <span class="n">transformer</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">query_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h3 class="doc doc-heading" id="datadog_checks.base.utils.db.core.QueryManager"> <code>datadog_checks.base.utils.db.core.QueryManager</code> <a class="headerlink" href="#datadog_checks.base.utils.db.core.QueryManager" title="Permanent link">¶</a></h3> <div class="doc doc-contents first"> <p>This class is in charge of running any number of <code>Query</code> instances for a single Check instance.</p> <p>You will most often see it created during Check initialization like this:</p> <div class="highlight"> <pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">_query_manager</span> <span class="o">=</span> <span class="n">QueryManager</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execute_query</span><span class="p">,</span>
    <span class="n">queries</span><span class="o">=</span><span class="p">[</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">SomeQuery1</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">SomeQuery2</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">SomeQuery3</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">SomeQuery4</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">SomeQuery5</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'tags'</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="n">error_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_sanitizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">check_initializations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_manager</span><span class="o">.</span><span class="n">compile_queries</span><span class="p">)</span>
</code></pre> </div> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.core.QueryManager.__init__"> <code class="highlight language-python"> __init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">executor</span><span class="p">,</span> <span class="n">queries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-special"><code>special</code></small> </span> <a class="headerlink" href="#datadog_checks.base.utils.db.core.QueryManager.__init__" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <ul> <li><strong>check</strong> (<em>AgentCheck</em>) - an instance of a Check</li> <li><strong>executor</strong> (<em>callable</em>) - a callable accepting a <code>str</code> query as its sole argument and returning a sequence representing either the full result set or an iterator over the result set</li> <li><strong>queries</strong> (<em>List[Query]</em>) - a list of <code>Query</code> instances</li> <li><strong>tags</strong> (<em>List[str]</em>) - a list of tags to associate with every submission</li> <li><strong>error_handler</strong> (<em>callable</em>) - a callable accepting a <code>str</code> error as its sole argument and returning a sanitized string, useful for scrubbing potentially sensitive information libraries emit</li> </ul> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">executor</span><span class="p">,</span> <span class="n">queries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    - **check** (_AgentCheck_) - an instance of a Check</span>
<span class="sd">    - **executor** (_callable_) - a callable accepting a `str` query as its sole argument and returning</span>
<span class="sd">      a sequence representing either the full result set or an iterator over the result set</span>
<span class="sd">    - **queries** (_List[Query]_) - a list of `Query` instances</span>
<span class="sd">    - **tags** (_List[str]_) - a list of tags to associate with every submission</span>
<span class="sd">    - **error_handler** (_callable_) - a callable accepting a `str` error as its sole argument and returning</span>
<span class="sd">      a sanitized string, useful for scrubbing potentially sensitive information libraries emit</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="n">queries</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">error_handler</span>

    <span class="n">custom_queries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'custom_queries'</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">use_global_custom_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'use_global_custom_queries'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Handle overrides</span>
    <span class="k">if</span> <span class="n">use_global_custom_queries</span> <span class="o">==</span> <span class="s1">'extend'</span><span class="p">:</span>
        <span class="n">custom_queries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">init_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'global_custom_queries'</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">custom_queries</span>
        <span class="ow">and</span> <span class="s1">'global_custom_queries'</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">init_config</span>
        <span class="ow">and</span> <span class="n">is_affirmative</span><span class="p">(</span><span class="n">use_global_custom_queries</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">custom_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">init_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'global_custom_queries'</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Deduplicate</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">custom_query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iter_unique</span><span class="p">(</span><span class="n">custom_queries</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="n">custom_query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">query_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'custom query #</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.core.QueryManager.compile_queries"> <code class="highlight language-python"> compile_queries<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.core.QueryManager.compile_queries" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>This method compiles every <code>Query</code> object.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>72
73
74
75
76
77
78
79
80
81
82</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">compile_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""This method compiles every `Query` object."""</span>
    <span class="n">column_transformers</span> <span class="o">=</span> <span class="n">COLUMN_TRANSFORMERS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">submission_method</span><span class="p">,</span> <span class="n">transformer_name</span> <span class="ow">in</span> <span class="n">SUBMISSION_METHODS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">,</span> <span class="n">submission_method</span><span class="p">)</span>
        <span class="c1"># Save each method in the initializer -&gt; callable format</span>
        <span class="n">column_transformers</span><span class="p">[</span><span class="n">transformer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_submission_transformer</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">column_transformers</span><span class="p">,</span> <span class="n">EXTRA_TRANSFORMERS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.core.QueryManager.execute"> <code class="highlight language-python"> execute<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.core.QueryManager.execute" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>This method is what you call every check run.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span> 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""This method is what you call every check run."""</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="o">.</span><span class="n">log</span>
    <span class="n">global_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">:</span>
        <span class="n">query_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">name</span>
        <span class="n">query_columns</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">query_extras</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">extras</span>
        <span class="n">query_tags</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">num_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_columns</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Error querying </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Error querying </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Query </span><span class="si">%s</span><span class="s1"> returned an empty result'</span><span class="p">,</span> <span class="n">query_name</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">num_columns</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">'Query </span><span class="si">%s</span><span class="s1"> expected </span><span class="si">%d</span><span class="s1"> column</span><span class="si">%s</span><span class="s1">, got </span><span class="si">%d</span><span class="s1">'</span><span class="p">,</span>
                    <span class="n">query_name</span><span class="p">,</span>
                    <span class="n">num_columns</span><span class="p">,</span>
                    <span class="s1">'s'</span> <span class="k">if</span> <span class="n">num_columns</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">''</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">submission_queue</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">global_tags</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">transformer</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">query_columns</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="c1"># Columns can be ignored via configuration</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">column_name</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">sources</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="n">column_type</span><span class="p">,</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>

                <span class="c1"># The transformer can be None for `source` types. Those such columns do not submit</span>
                <span class="c1"># anything but are collected into the row values for other columns to reference.</span>
                <span class="k">if</span> <span class="n">transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">column_type</span> <span class="o">==</span> <span class="s1">'tag'</span><span class="p">:</span>
                    <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transformer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">submission_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">transformer</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">submission_queue</span><span class="p">:</span>
                <span class="n">transformer</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="n">query_extras</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Error transforming </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.core.QueryManager.execute_query"> <code class="highlight language-python"> execute_query<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.core.QueryManager.execute_query" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Called by <code>execute</code>, this triggers query execution to check for errors immediately in a way that is compatible with any library. If there are no errors, this is guaranteed to return an iterator over the result set.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">execute_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Called by `execute`, this triggers query execution to check for errors immediately in a way that is compatible</span>
<span class="sd">    with any library. If there are no errors, this is guaranteed to return an iterator over the result set.</span>
<span class="sd">    """</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="c1"># Ensure we trigger query execution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>

    <span class="k">return</span> <span class="n">chain</span><span class="p">((</span><span class="n">first_row</span><span class="p">,),</span> <span class="n">rows</span><span class="p">)</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <h2 id="transformers">Transformers<a class="headerlink" href="#transformers" title="Permanent link">¶</a></h2> <p><br/></p> <div align="center"> <video autoplay="" loop="" muted="" preload="auto"> <source src="https://media.giphy.com/media/3RX9sUVwyCFSo/giphy.mp4" type="video/mp4"/> </video> </div> <div class="doc doc-object doc-class"> <h3 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers"> <code>datadog_checks.base.utils.db.transform.ColumnTransformers</code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers" title="Permanent link">¶</a></h3> <div class="doc doc-contents first"> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.match"> <code class="highlight language-python"> match<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.match" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>This is used for querying unstructured data.</p> <p>For example, say you want to collect the fields named <code>foo</code> and <code>bar</code>. Typically, they would be stored like:</p> <table> <thead> <tr> <th>foo</th> <th>bar</th> </tr> </thead> <tbody> <tr> <td>4</td> <td>2</td> </tr> </tbody> </table> <p>and would be queried like:</p> <div class="highlight"> <pre><span></span><code><span class="k">SELECT</span> <span class="n">foo</span><span class="p">,</span> <span class="n">bar</span> <span class="k">FROM</span> <span class="p">...</span>
</code></pre> </div> <p>Often, you will instead find data stored in the following format:</p> <table> <thead> <tr> <th>metric</th> <th>value</th> </tr> </thead> <tbody> <tr> <td>foo</td> <td>4</td> </tr> <tr> <td>bar</td> <td>2</td> </tr> </tbody> </table> <p>and would be queried like:</p> <div class="highlight"> <pre><span></span><code><span class="k">SELECT</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="k">FROM</span> <span class="p">...</span>
</code></pre> </div> <p>In this case, the <code>metric</code> column stores the name with which to match on and its <code>value</code> is stored in a separate column.</p> <p>The required <code>items</code> modifier is a mapping of matched names to column data values. Consider the values to be exactly the same as the entries in the <code>columns</code> top level field. You must also define a <code>source</code> modifier either for this transformer itself or in the values of <code>items</code> (which will take precedence). The source will be treated as the value of the match.</p> <p>Say this is your configuration:</p> <div class="highlight"> <pre><span></span><code><span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELECT source1, source2, metric FROM TABLE</span>
<span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value1</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value2</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">metric_name</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">match</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value1</span>
    <span class="nt">items</span><span class="p">:</span>
      <span class="nt">foo</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test.foo</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
        <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value2</span>
      <span class="nt">bar</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test.bar</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monotonic_gauge</span>
</code></pre> </div> <p>and the result set is:</p> <table> <thead> <tr> <th>source1</th> <th>source2</th> <th>metric</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>2</td> <td>foo</td> </tr> <tr> <td>3</td> <td>4</td> <td>baz</td> </tr> <tr> <td>5</td> <td>6</td> <td>bar</td> </tr> </tbody> </table> <p>Here's what would be submitted:</p> <ul> <li><code>foo</code> - <code>test.foo</code> as a <code>gauge</code> with a value of <code>2</code></li> <li><code>bar</code> - <code>test.bar.total</code> as a <code>gauge</code> and <code>test.bar.count</code> as a <code>monotonic_count</code>, both with a value of <code>5</code></li> <li><code>baz</code> - nothing since it was not defined as a match item</li> </ul> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_match</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    This is used for querying unstructured data.</span>

<span class="sd">    For example, say you want to collect the fields named `foo` and `bar`. Typically, they would be stored like:</span>

<span class="sd">    | foo | bar |</span>
<span class="sd">    | --- | --- |</span>
<span class="sd">    | 4   | 2   |</span>

<span class="sd">    and would be queried like:</span>

<span class="sd">    ```sql</span>
<span class="sd">    SELECT foo, bar FROM ...</span>
<span class="sd">    ```</span>

<span class="sd">    Often, you will instead find data stored in the following format:</span>

<span class="sd">    | metric | value |</span>
<span class="sd">    | ------ | ----- |</span>
<span class="sd">    | foo    | 4     |</span>
<span class="sd">    | bar    | 2     |</span>

<span class="sd">    and would be queried like:</span>

<span class="sd">    ```sql</span>
<span class="sd">    SELECT metric, value FROM ...</span>
<span class="sd">    ```</span>

<span class="sd">    In this case, the `metric` column stores the name with which to match on and its `value` is</span>
<span class="sd">    stored in a separate column.</span>

<span class="sd">    The required `items` modifier is a mapping of matched names to column data values. Consider the values</span>
<span class="sd">    to be exactly the same as the entries in the `columns` top level field. You must also define a `source`</span>
<span class="sd">    modifier either for this transformer itself or in the values of `items` (which will take precedence).</span>
<span class="sd">    The source will be treated as the value of the match.</span>

<span class="sd">    Say this is your configuration:</span>

<span class="sd">    ```yaml</span>
<span class="sd">    query: SELECT source1, source2, metric FROM TABLE</span>
<span class="sd">    columns:</span>
<span class="sd">      - name: value1</span>
<span class="sd">        type: source</span>
<span class="sd">      - name: value2</span>
<span class="sd">        type: source</span>
<span class="sd">      - name: metric_name</span>
<span class="sd">        type: match</span>
<span class="sd">        source: value1</span>
<span class="sd">        items:</span>
<span class="sd">          foo:</span>
<span class="sd">            name: test.foo</span>
<span class="sd">            type: gauge</span>
<span class="sd">            source: value2</span>
<span class="sd">          bar:</span>
<span class="sd">            name: test.bar</span>
<span class="sd">            type: monotonic_gauge</span>
<span class="sd">    ```</span>

<span class="sd">    and the result set is:</span>

<span class="sd">    | source1 | source2 | metric |</span>
<span class="sd">    | ------- | ------- | ------ |</span>
<span class="sd">    | 1       | 2       | foo    |</span>
<span class="sd">    | 3       | 4       | baz    |</span>
<span class="sd">    | 5       | 6       | bar    |</span>

<span class="sd">    Here's what would be submitted:</span>

<span class="sd">    - `foo` - `test.foo` as a `gauge` with a value of `2`</span>
<span class="sd">    - `bar` - `test.bar.total` as a `gauge` and `test.bar.count` as a `monotonic_count`, both with a value of `5`</span>
<span class="sd">    - `baz` - nothing since it was not defined as a match item</span>
<span class="sd">    """</span>
    <span class="c1"># Do work in a separate function to avoid having to `del` a bunch of variables</span>
    <span class="n">compiled_items</span> <span class="o">=</span> <span class="n">_compile_match_items</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">compiled_items</span><span class="p">:</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">compiled_items</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="n">transformer</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.monotonic_gauge"> <code class="highlight language-python"> monotonic_gauge<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.monotonic_gauge" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Send the result as both a <code>gauge</code> suffixed by <code>.total</code> and a <code>monotonic_count</code> suffixed by <code>.count</code>.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>51
52
53
54
55
56
57
58
59
60
61
62</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_monotonic_gauge</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Send the result as both a `gauge` suffixed by `.total` and a `monotonic_count` suffixed by `.count`.</span>
<span class="sd">    """</span>
    <span class="n">gauge</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'gauge'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.total'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">),</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>
    <span class="n">monotonic_count</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'monotonic_count'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.count'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">),</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">monotonic_gauge</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gauge</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">monotonic_count</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">monotonic_gauge</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.service_check"> <code class="highlight language-python"> service_check<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.service_check" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Submit a service check.</p> <p>The required modifier <code>status_map</code> is a mapping of values to statuses. Valid statuses include:</p> <ul> <li><code>OK</code></li> <li><code>WARNING</code></li> <li><code>CRITICAL</code></li> <li><code>UNKNOWN</code></li> </ul> <p>Any encountered values that are not defined will be sent as <code>UNKNOWN</code>.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_service_check</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Submit a service check.</span>

<span class="sd">    The required modifier `status_map` is a mapping of values to statuses. Valid statuses include:</span>

<span class="sd">    - `OK`</span>
<span class="sd">    - `WARNING`</span>
<span class="sd">    - `CRITICAL`</span>
<span class="sd">    - `UNKNOWN`</span>

<span class="sd">    Any encountered values that are not defined will be sent as `UNKNOWN`.</span>
<span class="sd">    """</span>
    <span class="c1"># Do work in a separate function to avoid having to `del` a bunch of variables</span>
    <span class="n">status_map</span> <span class="o">=</span> <span class="n">_compile_service_check_statuses</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>

    <span class="n">service_check_method</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'__service_check'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">service_check</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">service_check_method</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ServiceCheck</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">service_check</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.tag"> <code class="highlight language-python"> tag<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.tag" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Convert a column to a tag that will be used in every subsequent submission.</p> <p>For example, if you named the column <code>env</code> and the column returned the value <code>prod1</code>, all submissions from that row will be tagged by <code>env:prod1</code>.</p> <p>This also accepts an optional modifier called <code>boolean</code> that when set to <code>true</code> will transform the result to the string <code>true</code> or <code>false</code>. So for example if you named the column <code>alive</code> and the result was the number <code>0</code> the tag will be <code>alive:false</code>.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_tag</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Convert a column to a tag that will be used in every subsequent submission.</span>

<span class="sd">    For example, if you named the column `env` and the column returned the value `prod1`, all submissions</span>
<span class="sd">    from that row will be tagged by `env:prod1`.</span>

<span class="sd">    This also accepts an optional modifier called `boolean` that when set to `true` will transform the result</span>
<span class="sd">    to the string `true` or `false`. So for example if you named the column `alive` and the result was the</span>
<span class="sd">    number `0` the tag will be `alive:false`.</span>
<span class="sd">    """</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">:{{}}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
    <span class="n">boolean</span> <span class="o">=</span> <span class="n">is_affirmative</span><span class="p">(</span><span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'boolean'</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">is_affirmative</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tag</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.temporal_percent"> <code class="highlight language-python"> temporal_percent<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.temporal_percent" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Send the result as percentage of time since the last check run as a <code>rate</code>.</p> <p>For example, say the result is a forever increasing counter representing the total time spent pausing for garbage collection since start up. That number by itself is quite useless, but as a percentage of time spent pausing since the previous collection interval it becomes a useful metric.</p> <p>There is one required parameter called <code>scale</code> that indicates what unit of time the result should be considered. Valid values are:</p> <ul> <li><code>second</code></li> <li><code>millisecond</code></li> <li><code>microsecond</code></li> <li><code>nanosecond</code></li> </ul> <p>You may also define the unit as an integer number of parts compared to seconds e.g. <code>millisecond</code> is equivalent to <code>1000</code>.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span> 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_temporal_percent</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Send the result as percentage of time since the last check run as a `rate`.</span>

<span class="sd">    For example, say the result is a forever increasing counter representing the total time spent pausing for</span>
<span class="sd">    garbage collection since start up. That number by itself is quite useless, but as a percentage of time spent</span>
<span class="sd">    pausing since the previous collection interval it becomes a useful metric.</span>

<span class="sd">    There is one required parameter called `scale` that indicates what unit of time the result should be considered.</span>
<span class="sd">    Valid values are:</span>

<span class="sd">    - `second`</span>
<span class="sd">    - `millisecond`</span>
<span class="sd">    - `microsecond`</span>
<span class="sd">    - `nanosecond`</span>

<span class="sd">    You may also define the unit as an integer number of parts compared to seconds e.g. `millisecond` is</span>
<span class="sd">    equivalent to `1000`.</span>
<span class="sd">    """</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'scale'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `scale` parameter is required'</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TIME_UNITS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scale</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">'the `scale` parameter must be one of: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">' | '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TIME_UNITS</span><span class="p">)))</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'the `scale` parameter must be an integer representing parts of a second e.g. 1000 for millisecond'</span>
        <span class="p">)</span>

    <span class="n">rate</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'rate'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">temporal_percent</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rate</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">total_time_to_temporal_percent</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">temporal_percent</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ColumnTransformers.time_elapsed"> <code class="highlight language-python"> time_elapsed<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ColumnTransformers.time_elapsed" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Send the number of seconds elapsed from a time in the past as a <code>gauge</code>.</p> <p>For example, if the result is an instance of <a href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime.datetime</a> representing 5 seconds ago, then this would submit with a value of <code>5</code>.</p> <p>The optional modifier <code>format</code> indicates what format the result is in. By default it is <code>native</code>, assuming the underlying library provides timestamps as <code>datetime</code> objects. If it does not and passes them through directly as strings, you must provide the expected timestamp format using the <a href="https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes">supported codes</a>.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The code <code>%z</code> (lower case) is not supported on Windows.</p> </div> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_time_elapsed</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Send the number of seconds elapsed from a time in the past as a `gauge`.</span>

<span class="sd">    For example, if the result is an instance of</span>
<span class="sd">    [datetime.datetime](https://docs.python.org/3/library/datetime.html#datetime.datetime) representing 5 seconds ago,</span>
<span class="sd">    then this would submit with a value of `5`.</span>

<span class="sd">    The optional modifier `format` indicates what format the result is in. By default it is `native`, assuming the</span>
<span class="sd">    underlying library provides timestamps as `datetime` objects. If it does not and passes them through directly as</span>
<span class="sd">    strings, you must provide the expected timestamp format using the</span>
<span class="sd">    [supported codes](https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes).</span>

<span class="sd">    !!! note</span>
<span class="sd">        The code `%z` (lower case) is not supported on Windows.</span>
<span class="sd">    """</span>
    <span class="n">time_format</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'format'</span><span class="p">,</span> <span class="s1">'native'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_format</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `format` parameter must be a string'</span><span class="p">)</span>

    <span class="n">gauge</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'gauge'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_format</span> <span class="o">==</span> <span class="s1">'native'</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">time_elapsed</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">normalize_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">gauge</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">time_elapsed</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">normalize_datetime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">time_format</span><span class="p">))</span>
            <span class="n">gauge</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time_elapsed</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h3 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ExtraTransformers"> <code>datadog_checks.base.utils.db.transform.ExtraTransformers</code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ExtraTransformers" title="Permanent link">¶</a></h3> <div class="doc doc-contents first"> <p>Every column transformer (except <code>tag</code>) is supported at this level, the only difference being one must set a <code>source</code> to retrieve the desired value.</p> <p>So for example here:</p> <div class="highlight"> <pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">foo.bar</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rate</span>
<span class="nt">extras</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">foo.current</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">foo.bar</span>
</code></pre> </div> <p>the metric <code>foo.current</code> will be sent as a gauge will the value of <code>foo.bar</code>.</p> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ExtraTransformers.expression"> <code class="highlight language-python"> expression<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.expression" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>This allows the evaluation of a limited subset of Python syntax and built-in functions.</p> <div class="highlight"> <pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.used</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class="nt">extras</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.free</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
    <span class="nt">submit_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
</code></pre> </div> <p>For brevity, if the <code>expression</code> attribute exists and <code>type</code> does not then it is assumed the type is <code>expression</code>. The <code>submit_type</code> can be any transformer and any extra options are passed down to it.</p> <p>The result of every expression is stored, so in lieu of a <code>submit_type</code> the above example could also be written as:</p> <div class="highlight"> <pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.used</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class="nt">extras</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">free</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.free</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">free</span>
</code></pre> </div> <p>The order matters though, so for example the following will fail:</p> <div class="highlight"> <pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.used</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class="nt">extras</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.free</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">free</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">free</span>
    <span class="nt">expression</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
</code></pre> </div> <p>since the source <code>free</code> does not yet exist.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_expression</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    This allows the evaluation of a limited subset of Python syntax and built-in functions.</span>

<span class="sd">    ```yaml</span>
<span class="sd">    columns:</span>
<span class="sd">      - name: disk.total</span>
<span class="sd">        type: gauge</span>
<span class="sd">      - name: disk.used</span>
<span class="sd">        type: gauge</span>
<span class="sd">    extras:</span>
<span class="sd">      - name: disk.free</span>
<span class="sd">        expression: disk.total - disk.used</span>
<span class="sd">        submit_type: gauge</span>
<span class="sd">    ```</span>

<span class="sd">    For brevity, if the `expression` attribute exists and `type` does not then it is assumed the type is</span>
<span class="sd">    `expression`. The `submit_type` can be any transformer and any extra options are passed down to it.</span>

<span class="sd">    The result of every expression is stored, so in lieu of a `submit_type` the above example could also be written as:</span>

<span class="sd">    ```yaml</span>
<span class="sd">    columns:</span>
<span class="sd">      - name: disk.total</span>
<span class="sd">        type: gauge</span>
<span class="sd">      - name: disk.used</span>
<span class="sd">        type: gauge</span>
<span class="sd">    extras:</span>
<span class="sd">      - name: free</span>
<span class="sd">        expression: disk.total - disk.used</span>
<span class="sd">      - name: disk.free</span>
<span class="sd">        type: gauge</span>
<span class="sd">        source: free</span>
<span class="sd">    ```</span>

<span class="sd">    The order matters though, so for example the following will fail:</span>

<span class="sd">    ```yaml</span>
<span class="sd">    columns:</span>
<span class="sd">      - name: disk.total</span>
<span class="sd">        type: gauge</span>
<span class="sd">      - name: disk.used</span>
<span class="sd">        type: gauge</span>
<span class="sd">    extras:</span>
<span class="sd">      - name: disk.free</span>
<span class="sd">        type: gauge</span>
<span class="sd">        source: free</span>
<span class="sd">      - name: free</span>
<span class="sd">        expression: disk.total - disk.used</span>
<span class="sd">    ```</span>

<span class="sd">    since the source `free` does not yet exist.</span>
<span class="sd">    """</span>
    <span class="n">available_sources</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'sources'</span><span class="p">)</span>

    <span class="n">expression</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'expression'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `expression` parameter is required'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `expression` parameter must be a string'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `expression` parameter must not be empty'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'verbose'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Sort the sources in reverse order of length to prevent greedy matching</span>
        <span class="n">available_sources</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="c1"># Escape special characters, mostly for the possible dots in metric names</span>
        <span class="n">available_sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">available_sources</span><span class="p">))</span>

        <span class="c1"># Finally, utilize the order by relying on the guarantees provided by the alternation operator</span>
        <span class="n">available_sources</span> <span class="o">=</span> <span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_sources</span><span class="p">)</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="n">SOURCE_PATTERN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">available_sources</span><span class="p">),</span>
            <span class="c1"># Replace by the particular source that matched</span>
            <span class="k">lambda</span> <span class="n">match_obj</span><span class="p">:</span> <span class="s1">'SOURCES["</span><span class="si">{}</span><span class="s1">"]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">expression</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">expression</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'eval'</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">available_sources</span>

    <span class="k">if</span> <span class="s1">'submit_type'</span> <span class="ow">in</span> <span class="n">modifiers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">modifiers</span><span class="p">[</span><span class="s1">'submit_type'</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transformers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown submit_type `</span><span class="si">{}</span><span class="s1">`'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modifiers</span><span class="p">[</span><span class="s1">'submit_type'</span><span class="p">]))</span>

        <span class="n">submit_method</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'submit_type'</span><span class="p">)](</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">submit_method</span> <span class="o">=</span> <span class="n">create_extra_transformer</span><span class="p">(</span><span class="n">submit_method</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">execute_expression</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">ALLOWED_GLOBALS</span><span class="p">,</span> <span class="p">{</span><span class="s1">'SOURCES'</span><span class="p">:</span> <span class="n">sources</span><span class="p">})</span>
            <span class="n">submit_method</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">execute_expression</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">ALLOWED_GLOBALS</span><span class="p">,</span> <span class="p">{</span><span class="s1">'SOURCES'</span><span class="p">:</span> <span class="n">sources</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">execute_expression</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h4 class="doc doc-heading" id="datadog_checks.base.utils.db.transform.ExtraTransformers.percent"> <code class="highlight language-python"> percent<span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span> </code> <a class="headerlink" href="#datadog_checks.base.utils.db.transform.ExtraTransformers.percent" title="Permanent link">¶</a></h4> <div class="doc doc-contents"> <p>Send a percentage based on 2 sources as a <code>gauge</code>.</p> <p>The required modifiers are <code>part</code> and <code>total</code>.</p> <p>For example, if you have this configuration:</p> <div class="highlight"> <pre><span></span><code><span class="nt">columns</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.used</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class="nt">extras</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.utilized</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">percent</span>
    <span class="nt">part</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.used</span>
    <span class="nt">total</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk.total</span>
</code></pre> </div> <p>then the extra metric <code>disk.utilized</code> would be sent as a <code>gauge</code> calculated as <code>disk.used / disk.total * 100</code>.</p> <p>If the source of <code>total</code> is <code>0</code>, then the submitted value will always be sent as <code>0</code> too.</p> <details class="quote"> <summary>Source code in <code></code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">get_percent</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Send a percentage based on 2 sources as a `gauge`.</span>

<span class="sd">    The required modifiers are `part` and `total`.</span>

<span class="sd">    For example, if you have this configuration:</span>

<span class="sd">    ```yaml</span>
<span class="sd">    columns:</span>
<span class="sd">      - name: disk.total</span>
<span class="sd">        type: gauge</span>
<span class="sd">      - name: disk.used</span>
<span class="sd">        type: gauge</span>
<span class="sd">    extras:</span>
<span class="sd">      - name: disk.utilized</span>
<span class="sd">        type: percent</span>
<span class="sd">        part: disk.used</span>
<span class="sd">        total: disk.total</span>
<span class="sd">    ```</span>

<span class="sd">    then the extra metric `disk.utilized` would be sent as a `gauge` calculated as `disk.used / disk.total * 100`.</span>

<span class="sd">    If the source of `total` is `0`, then the submitted value will always be sent as `0` too.</span>
<span class="sd">    """</span>
    <span class="n">available_sources</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'sources'</span><span class="p">)</span>

    <span class="n">part</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'part'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `part` parameter is required'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `part` parameter must be a string'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_sources</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `part` parameter `</span><span class="si">{}</span><span class="s1">` is not an available source'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'total'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `total` parameter is required'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `total` parameter must be a string'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">total</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_sources</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'the `total` parameter `</span><span class="si">{}</span><span class="s1">` is not an available source'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>

    <span class="k">del</span> <span class="n">available_sources</span>
    <span class="n">gauge</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s1">'gauge'</span><span class="p">](</span><span class="n">transformers</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">modifiers</span><span class="p">)</span>
    <span class="n">gauge</span> <span class="o">=</span> <span class="n">create_extra_transformer</span><span class="p">(</span><span class="n">gauge</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gauge</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">compute_percent</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="n">part</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="n">total</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">percent</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <hr/> <div class="md-source-date"> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 15, 2020</span> </small> </div> </article> </div> </div> </main> <footer class="md-footer"> <div class="md-footer-nav"> <nav aria-label="Footer" class="md-footer-nav__inner md-grid"> <a class="md-footer-nav__link md-footer-nav__link--prev" href="../http/" rel="prev" title="HTTP"> <div class="md-footer-nav__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </div> <div class="md-footer-nav__title"> <div class="md-ellipsis"> <span class="md-footer-nav__direction"> Previous </span> HTTP </div> </div> </a> <a class="md-footer-nav__link md-footer-nav__link--next" href="../prometheus/" rel="next" title="Prometheus"> <div class="md-footer-nav__title"> <div class="md-ellipsis"> <span class="md-footer-nav__direction"> Next </span> Prometheus </div> </div> <div class="md-footer-nav__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-footer-copyright"> <div class="md-footer-copyright__highlight"> Copyright © Datadog, Inc. 2020-present </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-footer-social"> <a class="md-footer-social__link" href="https://www.datadoghq.com/blog/engineering/" rel="noopener" target="_blank" title="www.datadoghq.com"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M172.2 226.8c-14.6-2.9-28.2 8.9-28.2 23.8V301c0 10.2 7.1 18.4 16.7 22 18.2 6.8 31.3 24.4 31.3 45 0 26.5-21.5 48-48 48s-48-21.5-48-48V120c0-13.3-10.7-24-24-24H24c-13.3 0-24 10.7-24 24v248c0 89.5 82.1 160.2 175 140.7 54.4-11.4 98.3-55.4 109.7-109.7 17.4-82.9-37-157.2-112.5-172.2zM209 0c-9.2-.5-17 6.8-17 16v31.6c0 8.5 6.6 15.5 15 15.9 129.4 7 233.4 112 240.9 241.5.5 8.4 7.5 15 15.9 15h32.1c9.2 0 16.5-7.8 16-17C503.4 139.8 372.2 8.6 209 0zm.3 96c-9.3-.7-17.3 6.7-17.3 16.1v32.1c0 8.4 6.5 15.3 14.8 15.9 76.8 6.3 138 68.2 144.9 145.2.8 8.3 7.6 14.7 15.9 14.7h32.2c9.3 0 16.8-8 16.1-17.3-8.4-110.1-96.5-198.2-206.6-206.7z"></path></svg> </a> <a class="md-footer-social__link" href="https://github.com/DataDog" rel="noopener" target="_blank" title="github.com"> <svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg> </a> <a class="md-footer-social__link" href="https://twitter.com/datadoghq" rel="noopener" target="_blank" title="twitter.com"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> </a> <a class="md-footer-social__link" href="https://www.instagram.com/datadoghq" rel="noopener" target="_blank" title="www.instagram.com"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg> </a> </div> </div> </div> </footer> </div> <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script> <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src="../../assets/js/custom.js"></script> </body> </html>